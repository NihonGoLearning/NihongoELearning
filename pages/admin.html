<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel</title>
    <link rel="stylesheet" href="../css/main.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>Admin Panel</h1>
            <div class="user-info">
                <span id="currentUser">Welcome, Admin</span>
                <button onclick="logout()" class="logout-btn">Logout</button>
            </div>
        </header>
        
        <main>
            <div class="admin-panel">
                <h2>User Management</h2>
                
                <div class="add-user-form">
                    <h3>Add New User</h3>
                    <form id="addUserForm">
                        <div class="form-row">
                            <input type="text" id="newUsername" placeholder="Username" required>
                            <input type="password" id="newPassword" placeholder="Password" required>
                            <button type="submit" class="add-btn">Add User</button>
                        </div>
                    </form>
                </div>

                <div class="user-management">
                    <h3>Existing Users</h3>
                    <div id="userList" class="user-list">
                        <!-- Users will be loaded here -->
                    </div>
                </div>

                <div class="storage-info" style="margin-top: 2rem; padding: 1rem; background: #f9f9f9; border-radius: 5px;">
                    <h3>Storage Information</h3>
                    <div id="storageDetails">
                        <p>Users: <span id="userCount">0</span> accounts</p>
                        <p>Activities: <span id="activityCount">0</span> records</p>
                        <p>Total Storage: <span id="totalSize">0</span> KB</p>
                    </div>
                    <button onclick="clearAllData()" class="clear-btn" style="background: #e74c3c; color: white; padding: 0.5rem 1rem; border: none; border-radius: 3px; cursor: pointer; margin-top: 1rem;">Clear All Data</button>
                </div>
            </div>
        </main>
    </div>

    <script src="../js/user.js"></script>
    <script src="../js/main.js"></script>
    <script>
        // Check if admin is logged in
        document.addEventListener('DOMContentLoaded', function() {
            if (!isLoggedIn() || getCurrentUser().username !== 'admin') {
                window.location.href = '../login.html';
            } else {
                loadUsers();
                updateStorageInfo();
            }
        });

        document.getElementById('addUserForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const username = document.getElementById('newUsername').value;
            const password = document.getElementById('newPassword').value;
            
            if (!validateUsername(username)) {
                showNotification('Username must be at least 3 characters and contain only letters, numbers, and underscores', 'error');
                return;
            }
            
            if (!validatePassword(password)) {
                showNotification('Password must be at least 6 characters', 'error');
                return;
            }
            
            if (createUser(username, password)) {
                showNotification('User created successfully', 'success');
                document.getElementById('addUserForm').reset();
                loadUsers();
                updateStorageInfo();
            } else {
                showNotification('Username already exists', 'error');
            }
        });

        function loadUsers() {
            const users = getAllUsers();
            const userList = document.getElementById('userList');
            console.log('Loading users:', users);
            
            if (users && users.length > 0) {
                userList.innerHTML = users.map(user => `
                    <div class="user-item">
                        <div class="user-details">
                            <strong>${user.username}</strong>
                            <span>Created: ${formatDate(user.createdAt)}</span>
                        </div>
                        <div class="user-actions">
                            <button onclick="viewUserActivities('${user.username}')" class="view-btn" style="background: #3498db; color: white; padding: 0.25rem 0.5rem; border: none; border-radius: 3px; cursor: pointer;">View Activities</button>
                            <button onclick="deleteUserHandler('${user.username}')" class="delete-btn" style="background: #e74c3c; color: white; padding: 0.25rem 0.5rem; border: none; border-radius: 3px; cursor: pointer; margin-left: 0.5rem;">Delete</button>
                        </div>
                    </div>`
                ).join('');
            } else {
                userList.innerHTML = '<p>No users found.</p>';
            }
        }

        function viewUserActivities(username) {
            // Store the selected username and redirect to user management page
            localStorage.setItem('selectedUser', username);
            window.location.href = 'user-manage.html';
        }

        function deleteUserHandler(username) {
            console.log('Delete handler called for:', username);
            
            if (confirm(`Are you sure you want to delete user "${username}" and ALL their data?`)) {
                const result = deleteUser(username);
                console.log('Delete result:', result);
                
                if (result) {
                    showNotification('User deleted successfully and all data cleared', 'success');
                    loadUsers();
                    updateStorageInfo();
                } else {
                    showNotification('Failed to delete user. Please check console for details.', 'error');
                }
            }
        }

        function updateStorageInfo() {
            const info = getStorageInfo();
            if (info) {
                document.getElementById('userCount').textContent = info.users.count;
                document.getElementById('activityCount').textContent = info.activities.count;
                document.getElementById('totalSize').textContent = (info.totalSize / 1024).toFixed(2);
            }
        }

        function clearAllData() {
            if (confirm('WARNING: This will delete ALL users (except admin) and ALL activity records. This cannot be undone!')) {
                if (clearAllData()) {
                    showNotification('All data cleared successfully', 'success');
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } else {
                    showNotification('Failed to clear data', 'error');
                }
            }
        }

        function logout() {
            logoutUser();
            window.location.href = '../login.html';
        }
    </script>
</body>
</html>
